{{ partial "header.html" . }}
{{ $baseurl := .Site.BaseURL }}
<article>
  <header>
    <h1 class="text-primary">{{ .Title }}</h1>
    <div class="post-meta clearfix">
      <div class="post-date pull-left">
        Posted on
        <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" | safeHTML }}">
          {{ .Date.Format "Jan 2, 2006" }}
        </time>
      </div>
      <div class="pull-right">
        {{ range .Params.tags }}
        <span class="post-tag small"><a href="{{ $baseurl }}/tags/{{ . | urlize }}">#{{ . }}</a></span>
        {{ end }}
      </div>
    </div>
  </header>
  <section>
    {{ .Content }}
  </section>

  <section>
    <div id="comments">
    </div>
    <div id="submit-comments">
      <h2>Add a comment</h2>
      <div id="submit-error" class="submit-error"></div>
      <form id="submit-form" title="">
        Name:<br /><input id="submit-name" name="name" type="text" /><br />
        Website (optional):<br /><input id="submit-website" name="website" type="text" /><br />
        Comment:<br /><textarea id="submit-comment" name="comment"></textarea><br />

        <input type="submit" id="submit-button" />
      </form>
    </div>
    <script type="text/javascript">
      var renderComments = () => {
        const article = window.location.pathname.split('/')[1];
        var a = $.get(`/comment/${article}/`, function(data, err) {
          console.log(data, err);

          var c = $('#comments')[0];
          c.innerHTML = "";

          var comments = data.Items;
            
          if (comments.length != 0) {
              c.innerHTML += `<h1>Comments</h1>`;
          }

          for (var i in comments) {
            var com = comments[i];
            const body = $('<div/>').text(decodeURI(com.comment.S)).html().replace(/\n/g, '<br />');
            const name = $('<div/>').text(com.name.S).html();
            const date = $('<div/>').text(new Date(parseInt(com.ts.N))).html();
            var website = $('<div/>').text(com.website.S).html();
            if (!website.startsWith('http')) {
              website = "http://" + website;
            }
            var toAdd = `<div class="one-comment"><div class="comment-name">`;
            if (website !== 'null') {
              toAdd += `<a href="${website}">`;
            }
            toAdd += `${name}`;
            if (website !== 'null') {
              toAdd += `</a>`;
            }
              toAdd += `</div><div class="comment-time">${date}</div><div class="comment-body"><p>${body}</p></div></div>`;
            c.innerHTML += toAdd;
          }
        });
      };
      renderComments();
      var formEnabled = true;
      var submitForm = (event) => {
        if (!formEnabled) {
          return false;
        }
        var form = $(this);
        console.log(form);
        const name = $("#submit-name")[0].value;
        const website = $("#submit-website")[0].value;
        const comment = encodeURI($("#submit-comment")[0].value);
        const article = window.location.pathname.split('/')[1];
        toggleForm();
        $("#submit-error")[0].innerHTML = "";

        var a = $.ajax({
          type: "POST",
          beforeSend: function(req) {
            req.setRequestHeader("X-Comment-Name", name);
            req.setRequestHeader("X-Comment-Website", website);
            req.setRequestHeader("X-Comment-Comment", comment);
          },
          url: `/comment/${article}`,
          success: function(msg) {
            console.log(msg);
            if (msg.result === "error") {
              $("#submit-error")[0].innerHTML = `Error: ${msg.reason}`;
            } else {
              renderComments();
              $("#submit-name")[0].value = "";
              $("#submit-website")[0].value = "";
              $("#submit-comment")[0].value = "";
            }
            toggleForm();
          },
          error: function(err) {
            console.log(err);
            $("#submit-error")[0].innerHTML = `Error: ${err}`;
            toggleForm();
          }
        });
        return false;
      }
      $( "#submit-form" ).submit(submitForm);
      var toggleForm = () => {
        formEnabled = !formEnabled;
        $("#submit-name")[0].disabled = !$("#submit-name")[0].disabled;
        $("#submit-website")[0].disabled = !$("#submit-website")[0].disabled;
        $("#submit-comment")[0].disabled = !$("#submit-comment")[0].disabled;
        $("#submit-button")[0].disabled = !$("#submit-button")[0].disabled;
      };

    </script>
  </section>

  <footer>
    <section class="author-info row">
      <div class="author-avatar col-md-2">
        {{ with .Site.Params.avatar }}
        <img alt="Author Avatar" src="{{ . }}" />
        {{ end }}
      </div>
      <div class="author-meta col-md-6">
        {{ with .Site.Params.author }}
        <h1 class="author-name text-primary">{{ . }}</h1>
        {{ end }}
        {{ with .Site.Params.bio }}
        <div class="author-bio">{{ . }}</div>
        {{ end }}
      </div>
      {{ with .Site.Params.contact }}
      <div class="author-contact col-md-4">
        <a href="{{ . }}">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
      </div>
      {{ end }}
    </section>
    <ul class="pager">
      {{ if .Next }}
      <li class="previous"><a href="{{ .Next.Permalink }}"><span aria-hidden="true">&larr;</span> Older</a></li>
      {{ else }}
      <li class="previous disabled"><a href="#"><span aria-hidden="true">&larr;</span> Older</a></li>
      {{ end }}
      {{ if .Prev }}
      <li class="next"><a href="{{ .Prev.Permalink }}">Newer <span aria-hidden="true">&rarr;</span></a></li>
      {{ else }}
      <li class="next disabled"><a href="#">Newer <span aria-hidden="true">&rarr;</span></a></li>
      {{ end }}
    </ul>
  </footer>
</article>

{{ partial "footer.html" . }}
